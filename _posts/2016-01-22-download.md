---
title: "Download e estruturação dos dados do TJSP"
date: 2016-02-22
layout: post
comments: true
tags: aula
---

## Download de dados do TJSP

Este documento mostra como baixar os dados do site do TJSP.
Para os códigos que seguem, vamos assumir que a pasta onde serão
armazenados e processados todos os dados é `data-raw`.

Os dados presentes nesse arquivo contêm sentenças registradas em 2014 e 2015.
Essa é uma diferença importante em relação aos dados consolidados. Ou seja, 
pesquisadores interessados em analisar as bases mais cruas terão a oportunidade
de trabalhar com mais processos.

### Pacotes utilizados


{% highlight r %}
library(tjsp)
library(esaj)
library(dplyr)
library(multidplyr)
library(stringr)
library(lubridate)
{% endhighlight %}

### Escopo da pesquisa

Na CJPG, foi realizada uma pesquisa com as seguintes especificações:

- **Varas**: Apenas varas cíveis na comarca de São Paulo


|nm_muni   |nm_foro                                |nm_vara                                         |cod_vara |
|:---------|:--------------------------------------|:-----------------------------------------------|:--------|
|SÃO PAULO |Foro Regional I - Santana              |6ª Vara Cível                                   |1-6      |
|SÃO PAULO |Foro Regional I - Santana              |5ª Vara Cível                                   |1-5      |
|SÃO PAULO |Foro Regional I - Santana              |1ª Vara Cível                                   |1-1      |
|SÃO PAULO |Foro Regional I - Santana              |3ª Vara Cível                                   |1-3      |
|SÃO PAULO |Foro Regional I - Santana              |9ª Vara Cível                                   |1-9      |
|SÃO PAULO |Foro Regional I - Santana              |7ª Vara Cível                                   |1-7      |
|SÃO PAULO |Foro Regional I - Santana              |4ª Vara Cível                                   |1-4      |
|SÃO PAULO |Foro Regional I - Santana              |8ª Vara Cível                                   |1-8      |
|SÃO PAULO |Foro Regional I - Santana              |2ª Vara Cível                                   |1-2      |
|SÃO PAULO |Foro Regional II - Santo Amaro         |10ª Vara Civel                                  |2-6872   |
|SÃO PAULO |Foro Regional II - Santo Amaro         |Juizado Especial Cível Anexo UNIP               |2-13     |
|SÃO PAULO |Foro Regional II - Santo Amaro         |12ª Vara Cível                                  |2-6874   |
|SÃO PAULO |Foro Regional II - Santo Amaro         |1ª Vara do Juizado Especial Cível               |2-101    |
|SÃO PAULO |Foro Regional II - Santo Amaro         |14ª Vara Cível                                  |2-6876   |
|SÃO PAULO |Foro Regional II - Santo Amaro         |3ª Vara Cível                                   |2-3      |
|SÃO PAULO |Foro Regional II - Santo Amaro         |11ª Vara Cível                                  |2-6873   |
|SÃO PAULO |Foro Regional II - Santo Amaro         |Juizado Especial Cível - CIC Feitiço da Vila    |2-102    |
|SÃO PAULO |Foro Regional II - Santo Amaro         |5ª Vara Cível                                   |2-5      |
|SÃO PAULO |Foro Regional II - Santo Amaro         |6ª Vara Cível                                   |2-6      |
|SÃO PAULO |Foro Regional II - Santo Amaro         |7ª Vara Cível                                   |2-7      |
|SÃO PAULO |Foro Regional II - Santo Amaro         |2ª Vara do Juizado Especial Cível               |2-6865   |
|SÃO PAULO |Foro Regional II - Santo Amaro         |8ª Vara Cível                                   |2-8      |
|SÃO PAULO |Foro Regional II - Santo Amaro         |4ª Vara Cível                                   |2-4      |
|SÃO PAULO |Foro Regional II - Santo Amaro         |2ª Vara Cível                                   |2-2      |
|SÃO PAULO |Foro Regional II - Santo Amaro         |Juizado Especial Cível Anexo UNISA              |2-14     |
|SÃO PAULO |Foro Regional II - Santo Amaro         |13ª Vara Cível                                  |2-6875   |
|SÃO PAULO |Foro Regional II - Santo Amaro         |9ª Vara Cível                                   |2-6871   |
|SÃO PAULO |Foro Regional II - Santo Amaro         |1ª Vara Cível                                   |2-1      |
|SÃO PAULO |Foro Regional III - Jabaquara          |5ª Vara Cível                                   |3-5      |
|SÃO PAULO |Foro Regional III - Jabaquara          |3ª Vara Cível                                   |3-3      |
|SÃO PAULO |Foro Regional III - Jabaquara          |4ª Vara Cível                                   |3-4      |
|SÃO PAULO |Foro Regional III - Jabaquara          |Juizado Especial Cível Anexo UNIP               |3-6      |
|SÃO PAULO |Foro Regional III - Jabaquara          |1ª Vara Cível                                   |3-1      |
|SÃO PAULO |Foro Regional III - Jabaquara          |2ª Vara Cível                                   |3-2      |
|SÃO PAULO |Foro Regional III - Jabaquara          |1ª Vara do Juizado Especial Cível               |3-101    |
|SÃO PAULO |Foro Regional IV - Lapa                |4ª Vara Cível                                   |4-4      |
|SÃO PAULO |Foro Regional IV - Lapa                |Juizado Especial Cível Anexo UNIP               |4-6      |
|SÃO PAULO |Foro Regional IV - Lapa                |3ª Vara Cível                                   |4-3      |
|SÃO PAULO |Foro Regional IV - Lapa                |2ª Vara Cível                                   |4-2      |
|SÃO PAULO |Foro Regional IV - Lapa                |1ª Vara Cível                                   |4-1      |
|SÃO PAULO |Foro Regional IV - Lapa                |Juizado Especial Cível - CIC Zona Oeste         |4-102    |
|SÃO PAULO |Foro Regional IV - Lapa                |1ª Vara do Juizado Especial Cível               |4-101    |
|SÃO PAULO |Foro Regional V - São Miguel Paulista  |Juizado Especial Cível Anexo UNICSUL            |5-5      |
|SÃO PAULO |Foro Regional V - São Miguel Paulista  |2ª Vara Cível                                   |5-2      |
|SÃO PAULO |Foro Regional V - São Miguel Paulista  |4ª Vara Cível                                   |5-4      |
|SÃO PAULO |Foro Regional V - São Miguel Paulista  |Juizado Especial Cível - CIC Zona Leste         |5-102    |
|SÃO PAULO |Foro Regional V - São Miguel Paulista  |3ª Vara Cível                                   |5-3      |
|SÃO PAULO |Foro Regional V - São Miguel Paulista  |1ª Vara do Juizado Especial Cível               |5-101    |
|SÃO PAULO |Foro Regional V - São Miguel Paulista  |1ª Vara Cível                                   |5-1      |
|SÃO PAULO |Foro Regional VI - Penha de França     |2ª Vara Cível                                   |6-2      |
|SÃO PAULO |Foro Regional VI - Penha de França     |1ª Vara do Juizado Especial Cível               |6-101    |
|SÃO PAULO |Foro Regional VI - Penha de França     |4ª Vara Cível                                   |6-4      |
|SÃO PAULO |Foro Regional VI - Penha de França     |1ª Vara Cível                                   |6-1      |
|SÃO PAULO |Foro Regional VI - Penha de França     |3ª Vara Cível                                   |6-3      |
|SÃO PAULO |Foro Regional VII - Itaquera           |3ª Vara Cível                                   |7-3      |
|SÃO PAULO |Foro Regional VII - Itaquera           |2ª Vara Cível                                   |7-2      |
|SÃO PAULO |Foro Regional VII - Itaquera           |4ª Vara Cível                                   |7-4      |
|SÃO PAULO |Foro Regional VII - Itaquera           |Juizado Especial Cível Anexo UniCastelo         |7-103    |
|SÃO PAULO |Foro Regional VII - Itaquera           |1ª Vara Cível                                   |7-1      |
|SÃO PAULO |Foro Regional VII - Itaquera           |Vara do Juizado Especial Cível                  |7-101    |
|SÃO PAULO |Foro Regional VII - Itaquera           |5ª Vara Cível                                   |7-6847   |
|SÃO PAULO |Foro Regional VII - Itaquera           |Juizado Especial Cível Anexo Poupatempo         |7-102    |
|SÃO PAULO |Foro Regional VIII - Tatuapé           |4ª Vara Cível                                   |8-4      |
|SÃO PAULO |Foro Regional VIII - Tatuapé           |Juizado Especial Cível Anexo UNICID             |8-6      |
|SÃO PAULO |Foro Regional VIII - Tatuapé           |5ª Vara Cível                                   |8-7      |
|SÃO PAULO |Foro Regional VIII - Tatuapé           |3ª Vara Cível                                   |8-3      |
|SÃO PAULO |Foro Regional VIII - Tatuapé           |2ª Vara Cível                                   |8-2      |
|SÃO PAULO |Foro Regional VIII - Tatuapé           |1ª Vara do Juizado Especial Cível               |8-101    |
|SÃO PAULO |Foro Regional VIII - Tatuapé           |1ª Vara Cível                                   |8-1      |
|SÃO PAULO |Foro Regional IX - Vila Prudente       |1ª Vara Cível                                   |9-1      |
|SÃO PAULO |Foro Regional IX - Vila Prudente       |3ª Vara Cível                                   |9-3      |
|SÃO PAULO |Foro Regional IX - Vila Prudente       |1ª Vara do Juizado Especial Cível               |9-101    |
|SÃO PAULO |Foro Regional IX - Vila Prudente       |2ª Vara Cível                                   |9-2      |
|SÃO PAULO |Foro Regional IX - Vila Prudente       |4ª Vara Cível                                   |9-4      |
|SÃO PAULO |Foro Regional X - Ipiranga             |3ª Vara Cível                                   |10-3     |
|SÃO PAULO |Foro Regional X - Ipiranga             |1ª Vara do Juizado Especial Cível               |10-101   |
|SÃO PAULO |Foro Regional X - Ipiranga             |1ª Vara Cível                                   |10-1     |
|SÃO PAULO |Foro Regional X - Ipiranga             |2ª Vara Cível                                   |10-2     |
|SÃO PAULO |Foro Regional XI - Pinheiros           |1ª Vara Cível                                   |11-1     |
|SÃO PAULO |Foro Regional XI - Pinheiros           |5ª Vara Cível                                   |11-5     |
|SÃO PAULO |Foro Regional XI - Pinheiros           |2ª Vara Cível                                   |11-2     |
|SÃO PAULO |Foro Regional XI - Pinheiros           |4ª Vara Cível                                   |11-4     |
|SÃO PAULO |Foro Regional XI - Pinheiros           |3ª Vara Cível                                   |11-3     |
|SÃO PAULO |Foro Regional XI - Pinheiros           |1ª Vara do Juizado Especial Cível               |11-101   |
|SÃO PAULO |Foro Central Juizados Especiais Cíveis |1ª Vara do Juizado Especial Cível - Vergueiro   |16-101   |
|SÃO PAULO |Foro Central Juizados Especiais Cíveis |2ª Vara do Juizado Especial Cível - Vergueiro   |16-102   |
|SÃO PAULO |Foro Central Juizados Especiais Cíveis |Juizado Especial Cível Anexo FMU                |16-45    |
|SÃO PAULO |Foro Central Juizados Especiais Cíveis |Juizado Especial Cível Anexo Mackenzie          |16-46    |
|SÃO PAULO |Foro Central Juizados Especiais Cíveis |Juizado Especial Cível Anexo PUC                |16-47    |
|SÃO PAULO |Foro Central Juizados Especiais Cíveis |Anexo CIC Norte - Juizado Itinerante Permanente |16-906   |
|SÃO PAULO |Foro Central Juizados Especiais Cíveis |Juizado Especial Cível Digital                  |16-902   |
|SÃO PAULO |Foro Central Juizados Especiais Cíveis |Vara do Juizado Itinerante Permanente           |16-901   |
|SÃO PAULO |Foro Regional XII - Nossa Senhora do Ó |1ª Vara Cível                                   |20-1     |
|SÃO PAULO |Foro Regional XII - Nossa Senhora do Ó |4ª Vara Cível                                   |20-4     |
|SÃO PAULO |Foro Regional XII - Nossa Senhora do Ó |3ª Vara Cível                                   |20-3     |
|SÃO PAULO |Foro Regional XII - Nossa Senhora do Ó |2ª Vara Cível                                   |20-2     |
|SÃO PAULO |Foro Central Cível                     |44ª Vara Cível                                  |100-52   |
|SÃO PAULO |Foro Central Cível                     |34ª Vara Cível                                  |100-34   |
|SÃO PAULO |Foro Central Cível                     |25ª Vara Cível                                  |100-25   |
|SÃO PAULO |Foro Central Cível                     |9ª Vara Cível                                   |100-9    |
|SÃO PAULO |Foro Central Cível                     |3ª Vara Cível                                   |100-3    |
|SÃO PAULO |Foro Central Cível                     |16ª Vara Cível                                  |100-16   |
|SÃO PAULO |Foro Central Cível                     |10ª Vara Cível                                  |100-10   |
|SÃO PAULO |Foro Central Cível                     |8ª Vara Cível                                   |100-8    |
|SÃO PAULO |Foro Central Cível                     |2ª Vara Cível                                   |100-2    |
|SÃO PAULO |Foro Central Cível                     |1ª Vara Cível                                   |100-1    |
|SÃO PAULO |Foro Central Cível                     |2ª Vara do Juizado Especial Cível - Vergueiro   |100-102  |
|SÃO PAULO |Foro Central Cível                     |14ª Vara Cível                                  |100-14   |
|SÃO PAULO |Foro Central Cível                     |17ª Vara Cível                                  |100-17   |
|SÃO PAULO |Foro Central Cível                     |29ª Vara Cível                                  |100-29   |
|SÃO PAULO |Foro Central Cível                     |32ª Vara Cível                                  |100-32   |
|SÃO PAULO |Foro Central Cível                     |20ª Vara Cível                                  |100-20   |
|SÃO PAULO |Foro Central Cível                     |35ª Vara Cível                                  |100-35   |
|SÃO PAULO |Foro Central Cível                     |45ª Vara Cível                                  |100-53   |
|SÃO PAULO |Foro Central Cível                     |43ª Vara CÍvel                                  |100-51   |
|SÃO PAULO |Foro Central Cível                     |15ª Vara Cível                                  |100-15   |
|SÃO PAULO |Foro Central Cível                     |33ª Vara Cível                                  |100-33   |
|SÃO PAULO |Foro Central Cível                     |Vara do Juizado Itinerante Permanente           |100-901  |
|SÃO PAULO |Foro Central Cível                     |37ª Vara Cível                                  |100-37   |
|SÃO PAULO |Foro Central Cível                     |31ª Vara Cível                                  |100-31   |
|SÃO PAULO |Foro Central Cível                     |28ª Vara Cível                                  |100-28   |
|SÃO PAULO |Foro Central Cível                     |22ª Vara Cível                                  |100-22   |
|SÃO PAULO |Foro Central Cível                     |40ª Vara Cível                                  |100-40   |
|SÃO PAULO |Foro Central Cível                     |6ª Vara Cível                                   |100-6    |
|SÃO PAULO |Foro Central Cível                     |13ª Vara Cível                                  |100-13   |
|SÃO PAULO |Foro Central Cível                     |19ª Vara Cível                                  |100-19   |
|SÃO PAULO |Foro Central Cível                     |1ª Vara do Juizado Especial Cível - Vergueiro   |100-101  |
|SÃO PAULO |Foro Central Cível                     |21ª Vara Cível                                  |100-21   |
|SÃO PAULO |Foro Central Cível                     |27ª Vara Cível                                  |100-27   |
|SÃO PAULO |Foro Central Cível                     |12ª Vara Cível                                  |100-12   |
|SÃO PAULO |Foro Central Cível                     |18ª Vara Cível                                  |100-18   |
|SÃO PAULO |Foro Central Cível                     |30ª Vara Cível                                  |100-30   |
|SÃO PAULO |Foro Central Cível                     |36ª Vara Cível                                  |100-36   |
|SÃO PAULO |Foro Central Cível                     |4ª Vara Cível                                   |100-4    |
|SÃO PAULO |Foro Central Cível                     |11ª Vara Cível                                  |100-11   |
|SÃO PAULO |Foro Central Cível                     |26ª Vara Cível                                  |100-26   |
|SÃO PAULO |Foro Central Cível                     |23ª Vara Cível                                  |100-23   |
|SÃO PAULO |Foro Central Cível                     |38ª Vara Cível                                  |100-38   |
|SÃO PAULO |Foro Central Cível                     |41ª Vara Cível                                  |100-41   |
|SÃO PAULO |Foro Central Cível                     |7ª Vara Cível                                   |100-7    |
|SÃO PAULO |Foro Central Cível                     |24ª Vara Cível                                  |100-24   |
|SÃO PAULO |Foro Central Cível                     |42ª Vara Cível                                  |100-42   |
|SÃO PAULO |Foro Central Cível                     |39ª Vara Cível                                  |100-39   |
|SÃO PAULO |Foro Central Cível                     |5ª Vara Cível                                   |100-5    |
|SÃO PAULO |Foro Regional XV - Butantã             |Vara do Juizado Especial Cível                  |704-8    |
|SÃO PAULO |Foro Regional XV - Butantã             |3ª Vara Cível                                   |704-13   |
|SÃO PAULO |Foro Regional XV - Butantã             |1ª Vara Cível                                   |704-1    |
|SÃO PAULO |Foro Regional XV - Butantã             |2ª Vara Cível                                   |704-2    |

- **Classes**: Procedimento Ordinário, Procedimento Sumário e Procedimento do
Juizado Especial Cível.



|classe_pai                                                                             |classe                                 |cod  |
|:--------------------------------------------------------------------------------------|:--------------------------------------|:----|
|PROCESSO CÍVEL E DO TRABALHO / Processo de Conhecimento / Procedimento de Conhecimento |Procedimento Ordinário                 |8501 |
|PROCESSO CÍVEL E DO TRABALHO / Processo de Conhecimento / Procedimento de Conhecimento |Procedimento Sumário                   |8502 |
|PROCESSO CÍVEL E DO TRABALHO / Processo de Conhecimento / Procedimento de Conhecimento |Procedimento do Juizado Especial Cível |8714 |

- Intervalo de tempo: Sentenças disponibilizadas entre 01/01/2014 e 31/12/2015.

Os dados foram consultados de mês em mês para tornar a busca mais rápida.
Os arquivos HTML correspondem às páginas de resultados da pesquisa para cada mês.
Cada página contém 15 sentenças. No entanto, as páginas caminham de dez em dez
sentenças e, por isso, temos 5 repetições por página.

## Download e parse dos arquivos HTML

Os arquivos HTML foram baixados diretamente dos sites dos tribunais e 
armazenados no Dropbox. Os arquivos vêm de duas origens: a
[consulta de julgados de primeiro grau (CJPG)](https://esaj.tjsp.jus.br/cjpg/) e a
[consulta de processos de primeiro grau (CPO-PG)](https://esaj.tjsp.jus.br/cpopg/open.do).

### Download CJPG

Pesquisa realizada em 23/02/2016.
Datas entre 01/01/2014 e 31/12/2015.
Quebramos as pesquisas por mês para tornar o algoritmo mais rápido, pois
o site do TJSP fica lento ao acessar páginas com índices > 1000.
A pesquisa demorou aproximadamente 8 horas.


{% highlight r %}
d0 <- as.Date('2014-01-01') + months(0:23)
d1 <- as.Date('2014-01-01') + months(1:24) - 1
cjpg_l <- list()
for(i in seq_along(d0)) {
  nm <- format(d0[i], '%Y%m')
  p <- sprintf('data-raw/cjpg/%s', nm)
  suppressWarnings(dir.create(p))
  # Essa é a fç que baixa os dados
  cjpg_l[[nm]] <- cjpg(classes = cl, varas = va, 
                       datas = c(d0[i], d1[i]), path = p)
  cjpg_l[[nm]]$yearmon <- nm
}

# Salvando log dos resultados da cjpg.
cjpg_res <- dplyr::bind_rows(cjpg_l)
saveRDS(cjpg_res, 'data-raw/cjpg_res.rds')
{% endhighlight %}

Os arquivos HTML estão disponíveis [nesse link](https://www.dropbox.com/s/6i4om1790ncnkj4/cjpg.zip?dl=0).

### Parse CJPG

A leitura dos arquivos demora aproximadamente uma hora.


{% highlight r %}
# Carregando os nomes dos arquivos a partir das pastas
# O código é um pouco complicado pois estamos pegando
# arquivos de várias pastas.
d_cjpg <- sprintf('data-raw/cjpg', normalizePath(path)) %>% 
  dir(full.names = TRUE) %>% 
  {data_frame(pasta = .)} %>% 
  group_by(pasta) %>% 
  do(data_frame(arq = dir(.$pasta, full.names = TRUE))) %>% 
  ungroup() %>% 
  mutate(pasta = str_extract(pasta, '[0-9]+$')) %>% 
  group_by(pasta, arq) %>% 
  # aqui aplicamos o parser aos arquivos
  do(parse_cjpg_pag(.$arq)) %>% 
  ungroup() %>% 
  distinct(cod_sentenca)

# Salvando d_cjpg.rds
saveRDS(d_cjpg, 'data-raw/d_cjpg.rds')
{% endhighlight %}

O resultado do download, após estruturação, também está disponível para download
[nesse link](https://www.dropbox.com/s/7tacun9dwnngt9x/d_cjpg.rds?dl=0). O arquivo pode ser lido usando a função `readRDS` do `R`:


{% highlight r %}
d_cpopg <- readRDS('data-raw/d_cpopg.rds')
{% endhighlight %}

### CPO-PG

A Consulta de Processos de Primeiro Grau permite obter dados adicionais
dos processos, como partes, valor da causa e andamentos. A pesquisa é realizada
a partir de um número de processo. Para essa tarefa, utilizamos os processos
obtidos na CJPG do passo anterior.

A pesquisa foi realizada em 25/02/2016.
Utilizamos processamento paralelo para aumentar quantidade de acessos.
A pesquisa demorou aproximadamente dois dias 
utilizando quatro núcleos de processamento.


{% highlight r %}
# Processos que queremos baixar
p <- unique(d_cjpg$n_processo)

dir.create('data-raw/cpo-pg')
d_cpopg_res <- cpo_pg(p, path = 'data-raw/cpo-pg')

# Salvando log dos resultados da cpopg.
saveRDS(d_cpopg_res, 'data-raw/d_cpopg_res.rds')
{% endhighlight %}

#### Download

Faça o download do arquivo compactado com os arquivos HTML [aqui](https://www.dropbox.com/s/613ojiswhgugqxd/cpopg.zip?dl=0) (7.1gb).

### Parse CPO-PG

A leitura dos arquivos demora aproximadamente doze horas,
utilizando quatro núcleos de processamento.


{% highlight r %}
# Carrega os caminhos dos arquivos baixados
arqs <- dir('data-raw/cpo-pg', full.names = TRUE)
# Utiliza processamento paralelo
d_cpopg <- parse_cpopg(arqs)
# Salvando d_cpopg.rds
saveRDS(d_cpopg, 'data-raw/d_cpopg.rds')
{% endhighlight %}

O resultado do download, após estruturação, também está disponível para download
[nesse link](https://www.dropbox.com/s/s83sn77whakhidv/d_cpopg.rds?dl=0). O arquivo pode ser lido usando a função `readRDS` do `R`:


{% highlight r %}
d_cpopg <- readRDS('data-raw/d_cpopg.rds')
{% endhighlight %}

### Contato

Se tiver dúvidas de como trabalhar com os dados, envie um e-mail para
[jtrecenti@abjur.org.br](mailto:jtrecenti@abjur.org.br).

